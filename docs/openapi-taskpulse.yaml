
> В markdown-редакторе с поддержкой Mermaid ты увидишь картинку-схему.

---

## 4. Добавляем OpenAPI-черновик

Тоже документация, код не трогаем.

### 4.1. Создаём файл OpenAPI

Создай файл:
`TaskPulse/docs/openapi-taskpulse.yaml`

Вставь в него **полностью**:

```yaml
openapi: 3.0.0
info:
  title: TaskPulse API
  version: 1.0.0

servers:
  - url: https://api.yourdomain.com
    description: Production
  - url: http://localhost:8000
    description: Local dev

paths:
  /api/auth/register/:
    post:
      summary: Register new user
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                first_name:
                  type: string
                last_name:
                  type: string
              required: [email, password]
      responses:
        "201":
          description: User created, verification email sent
        "400":
          description: Validation error

  /api/auth/login/:
    post:
      summary: Login with email and password
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
              required: [email, password]
      responses:
        "200":
          description: Auth token
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
        "400":
          description: Invalid credentials

  /api/auth/verify-email/:
    get:
      summary: Verify email by token
      tags: [Auth]
      parameters:
        - in: query
          name: token
          schema:
            type: string
            format: uuid
          required: true
      responses:
        "200":
          description: Email verified
        "400":
          description: Invalid or expired token

  /api/auth/resend-verification/:
    post:
      summary: Resend verification email
      tags: [Auth]
      security:
        - TokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
              required: [email]
      responses:
        "200":
          description: Verification email sent
        "429":
          description: Too many requests

  /api/auth/invite/:
    post:
      summary: Invite executor
      tags: [Auth]
      security:
        - TokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
              required: [email]
      responses:
        "201":
          description: Invitation created
        "400":
          description: Validation error

  /api/auth/accept-invite/:
    post:
      summary: Accept invitation and create executor
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  format: uuid
                password:
                  type: string
              required: [token, password]
      responses:
        "201":
          description: Executor created
        "400":
          description: Invalid or expired token

  /api/auth/executors/:
    get:
      summary: List executors of current creator
      tags: [Auth]
      security:
        - TokenAuth: []
      responses:
        "200":
          description: List of executors
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserShort"

  /api/auth/profile/:
    get:
      summary: Get current user profile
      tags: [Auth]
      security:
        - TokenAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

    patch:
      summary: Update current user profile
      tags: [Auth]
      security:
        - TokenAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserUpdate"
      responses:
        "200":
          description: Updated profile

  /api/auth/change-password/:
    post:
      summary: Change password
      tags: [Auth]
      security:
        - TokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                old_password:
                  type: string
                new_password:
                  type: string
              required: [old_password, new_password]
      responses:
        "200":
          description: Password changed
        "400":
          description: Invalid old password

  /api/tasks/:
    get:
      summary: List tasks (creator / executor with filters)
      tags: [Tasks]
      security:
        - TokenAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: priority
          schema:
            type: string
        - in: query
          name: assignee
          schema:
            type: integer
        - in: query
          name: search
          schema:
            type: string
      responses:
        "200":
          description: List of tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Task"

    post:
      summary: Create task
      tags: [Tasks]
      security:
        - TokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskCreate"
      responses:
        "201":
          description: Task created

  /api/tasks/{id}/:
    get:
      summary: Retrieve task
      tags: [Tasks]
      security:
        - TokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Task detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskDetail"

    patch:
      summary: Update task
      tags: [Tasks]
      security:
        - TokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskUpdate"
      responses:
        "200":
          description: Updated task

    delete:
      summary: Delete task
      tags: [Tasks]
      security:
        - TokenAuth: []
      responses:
        "204":
          description: Deleted

  /api/cabinet/creator/tasks/:
    get:
      summary: Creator tasks list
      tags: [Cabinet]
      security:
        - TokenAuth: []
      parameters:
        - in: query
          name: ordering
          schema:
            type: string
            description: "created_at, -created_at, due_at, -due_at, etc."
      responses:
        "200":
          description: List of tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Task"

  /api/cabinet/creator/stats-by-assignee/:
    get:
      summary: Stats by assignee for current creator
      tags: [Cabinet]
      security:
        - TokenAuth: []
      responses:
        "200":
          description: Stats
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
                  properties:
                    total:
                      type: integer
                    done:
                      type: integer
                    in_progress:
                      type: integer
                    new:
                      type: integer

  /api/cabinet/executor/tasks/:
    get:
      summary: Tasks for current executor
      tags: [Cabinet]
      security:
        - TokenAuth: []
      responses:
        "200":
          description: List of tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Task"

  /api/cabinet/executor/tasks/{id}/:
    get:
      summary: Executor view of task
      tags: [Cabinet]
      security:
        - TokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Task with messages, attachments etc.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskExecutorDetail"

  /api/reports/monthly/:
    get:
      summary: Monthly KPI report
      tags: [Reports]
      security:
        - TokenAuth: []
      parameters:
        - in: query
          name: user
          schema:
            type: string
            description: "me or user id"
        - in: query
          name: month
          schema:
            type: string
            example: "2025-01"
        - in: query
          name: format
          schema:
            type: string
            enum: [json, csv]
      responses:
        "200":
          description: KPI report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MonthlyKpi"

  /api/tasks/conversation-messages/:
    get:
      summary: Get conversation messages between current user and another user
      tags: [Tasks]
      security:
        - TokenAuth: []
      parameters:
        - in: query
          name: user_id
          schema:
            type: integer
          required: true
      responses:
        "200":
          description: Messages list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TaskMessage"

    post:
      summary: Send message in task conversation
      tags: [Tasks]
      security:
        - TokenAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                task:
                  type: integer
                text:
                  type: string
                file:
                  type: string
                  format: binary
              required: [task]
      responses:
        "201":
          description: Message created

  /api/integrations/telegram/profile/:
    get:
      summary: Get Telegram profile linked to current user
      tags: [Telegram]
      security:
        - TokenAuth: []
      responses:
        "200":
          description: Telegram profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TelegramProfile"
        "404":
          description: Not linked

  /api/telegram/webhook/:
    post:
      summary: Telegram webhook endpoint
      tags: [Telegram]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Update processed
        "403":
          description: Invalid secret

components:
  securitySchemes:
    TokenAuth:
      type: http
      scheme: bearer
      bearerFormat: Token

  schemas:
    UserShort:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        full_name:
          type: string

    User:
      allOf:
        - $ref: "#/components/schemas/UserShort"
        - type: object
          properties:
            role:
              type: string
              enum: [CREATOR, EXECUTOR]
            timezone:
              type: string
            is_email_verified:
              type: boolean

    UserUpdate:
      type: object
      properties:
        first_name:
          type: string
        last_name:
          type: string
        timezone:
          type: string

    Task:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        priority:
          type: string
          enum: [LOW, MEDIUM, HIGH]
        status:
          type: string
          enum: [NEW, IN_PROGRESS, DONE]
        due_at:
          type: string
          format: date-time
        creator:
          $ref: "#/components/schemas/UserShort"
        assignee:
          $ref: "#/components/schemas/UserShort"

    TaskCreate:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        priority:
          type: string
        assignee:
          type: integer
        due_at:
          type: string
          format: date-time
      required: [title, assignee]

    TaskUpdate:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        priority:
          type: string
        status:
          type: string
        assignee:
          type: integer
        due_at:
          type: string
          format: date-time

    TaskDetail:
      allOf:
        - $ref: "#/components/schemas/Task"
        - type: object
          properties:
            attachments:
              type: array
              items:
                $ref: "#/components/schemas/TaskAttachment"
            messages:
              type: array
              items:
                $ref: "#/components/schemas/TaskMessage"
            actions:
              type: array
              items:
                $ref: "#/components/schemas/TaskActionLog"

    TaskExecutorDetail:
      allOf:
        - $ref: "#/components/schemas/TaskDetail"

    TaskAttachment:
      type: object
      properties:
        id:
          type: integer
        file:
          type: string
        kind:
          type: string

    TaskMessage:
      type: object
      properties:
        id:
          type: integer
        task:
          type: integer
        text:
          type: string
        file:
          type: string
          nullable: true
        sender:
          $ref: "#/components/schemas/UserShort"
        created_at:
          type: string
          format: date-time

    TaskActionLog:
      type: object
      properties:
        id:
          type: integer
        action_type:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time

    MonthlyKpi:
      type: object
      properties:
        year:
          type: integer
        month:
          type: integer
        user_id:
          type: integer
        total:
          type: integer
        done:
          type: integer
        done_on_time:
          type: integer
        done_late:
          type: integer
        by_priority:
          type: array
          items:
            type: object
            properties:
              priority:
                type: string
              total:
                type: integer
              done:
                type: integer
              done_on_time:
                type: integer
              done_late:
                type: integer

    TelegramProfile:
      type: object
      properties:
        chat_id:
          type: integer
        username:
          type: string
        first_name:
          type: string
        last_name:
          type: string
