# **TaskPulse --- Backend Design Specification**

## 1. Назначение и область документа

Документ описывает серверную часть (Backend) системы **TaskPulse**:
доменные модели, бизнес-функции, роли и права, интеграции, фоновые
задачи и нефункциональные требования.\
Документ служит источником истины для разработчиков, QA и DevOps.\
Фронтенд и UX вне рамок этого документа.

------------------------------------------------------------------------

## 2. Технологический стек и архитектура

-   **Язык и фреймворки:** Python 3.13, Django 5.x, Django REST
    Framework\
-   **База данных:** PostgreSQL\
-   **Веб-сервер/прокси:** Nginx\
-   **Интеграции:** Telegram Bot API (webhook), SMTP (email)

------------------------------------------------------------------------

## 3. Обзор доменной модели

Система управляет сущностями: - **Task** --- задачи\
- **User** --- пользователи\
- **Attachment** --- вложения\
- **Comment** --- комментарии\
- **NotificationLog** --- отправленные уведомления\
- **Report** --- отчёты

Роли пользователей: - **CREATOR** --- создатель задачи\
- **EXECUTOR** --- исполнитель

Создатель назначает задачи исполнителям. Система отправляет напоминания
за 24 часа до срока через Telegram.

------------------------------------------------------------------------

## 4. Модели данных (Django ORM)

### 4.1 User

**Назначение:** хранение учётных записей, ролей и идентификаторов
интеграций.\
Пользователь может быть создателем и/или исполнителем задач.

  ------------------------------------------------------------------------------
  Поле            Тип              Обяз.              Описание
  --------------- ---------------- ------------------ --------------------------
  id              UUID             ✅                 PK, генерируется

  email           string(255)      ✅                 Уникальный email
                                                      (lowercase)

  password_hash   string           ✅                 bcrypt/argon2

  role            enum\[CREATOR,   ✅                 DEFAULT=EXECUTOR
                  EXECUTOR,                           
                  ADMIN\]                             

  first_name /    string(120)      ❌                 Имя/фамилия
  last_name                                           

  timezone        string           ❌                 DEFAULT=UTC

  telegram_id     string           ❌                 UNIQUE, nullable

  is_active       bool             ✅                 DEFAULT=true

  created_at /    timestamp        ✅                 Автоматические поля аудита
  updated_at                                          
  ------------------------------------------------------------------------------

**Бизнес-правила:** - Email хранится в нижнем регистре\
- Подтверждение email обязательно\
- Блокировка при множественных неудачных входах

------------------------------------------------------------------------

### 4.2 Task

**Назначение:** основная сущность для управления работой.

  Поле                      Тип                                        Обяз.   Описание
  ------------------------- ------------------------------------------ ------- --------------------
  id                        UUID                                       ✅      PK
  title                     string(255)                                ✅      Краткое название
  description               text                                       ❌      Подробное описание
  creator_id                UUID→User                                  ✅      Создатель
  assignee_id               UUID→User                                  ❌      Исполнитель
  priority                  enum\[LOW, MEDIUM, HIGH\]                  ✅      DEFAULT=MEDIUM
  status                    enum\[OPEN, IN_PROGRESS, DONE, OVERDUE\]   ✅      DEFAULT=OPEN
  due_at                    timestamp                                  ❌      Дедлайн
  closed_at                 timestamp                                  ❌      Завершение
  postponed_count           int                                        ✅      DEFAULT=0
  created_at / updated_at   timestamp                                  ✅      Аудит

**Бизнес-правила:** - Только CREATOR/ADMIN могут создавать и назначать\
- Исполнитель может менять статус в допустимых переходах\
- Перенос срока логируется\
- DONE нельзя редактировать (кроме комментариев/вложений)

------------------------------------------------------------------------

### 4.3 NotificationLog

**Назначение:** журнал отправки уведомлений и действий получателей.

  ------------------------------------------------------------------------------
  Поле           Тип               Обяз.              Описание
  -------------- ----------------- ------------------ --------------------------
  id             UUID              ✅                 PK

  task_id        UUID→Task         ✅                 FK

  recipient_id   UUID→User         ✅                 FK

  channel        enum\[telegram,   ✅                 Канал доставки
                 email\]                              

  type           enum\[assign,     ✅                 Тип уведомления
                 reminder24h,                         
                 confirm,                             
                 postpone\]                           

  payload        jsonb             ❌                 Данные запроса/ответа

  status         enum\[queued,     ✅                 DEFAULT=queued
                 sent, delivered,                     
                 failed\]                             

  delivered_at   timestamp         ❌                 Когда доставлено

  created_at     timestamp         ✅                 Когда создана запись
  ------------------------------------------------------------------------------

**Бизнес-правила:** - Ретраи фиксируются\
- Idempotency по внешним message_id (если доступно)

------------------------------------------------------------------------

## 5. Роли и доступы (RBAC)

  -----------------------------------------------------------------------
  Роль                           Права
  ------------------------------ ----------------------------------------
  **CREATOR**                    Создание, редактирование и удаление
                                 своих задач; назначение исполнителей;
                                 перенос сроков

  **EXECUTOR**                   Просмотр назначенных задач; изменение
                                 статуса; добавление комментариев и
                                 вложений

  **ADMIN**                      Полные права, включая системные операции
                                 (управление пользователями, очистка,
                                 реиндексация)
  -----------------------------------------------------------------------

------------------------------------------------------------------------

## 6. Основные сервисы

### 6.1 Сервис аутентификации и профиля

-   Регистрация, вход/выход\
-   Обновление токенов\
-   Сброс и смена пароля\
-   Подтверждение email\
-   Обновление профиля (имя, часовой пояс)\
-   Привязка `telegram_id`

------------------------------------------------------------------------

### 6.2 Сервис задач (Task Service)

-   Создание и назначение задачи (CREATOR/ADMIN)\
-   Поиск и фильтрация (по статусу, приоритету, срокам, участникам,
    тексту)\
-   Переходы статусов: `OPEN → IN_PROGRESS → DONE`, `REOPEN` из DONE\
-   Автоматический `OVERDUE` при просрочке\
-   Перенос срока (`postpone`) с фиксацией причины\
-   Подтверждение «выполню вовремя»\
-   История изменений (аудит)

------------------------------------------------------------------------

### 6.3 Сервис уведомлений (Notification Service)

-   Отправка сообщений в Telegram: назначение, напоминания,
    подтверждения, переносы\
-   Инлайн-кнопки: «Продлить на сутки», «Сделаю вовремя»\
-   Хранение статусов доставки и ретраев в `NotificationLog`

------------------------------------------------------------------------

## 8. Интеграции

-   **Telegram Bot API:** входящий webhook\
-   **Email SMTP:** подтверждение email, восстановление пароля,
    системные уведомления (опционально)
