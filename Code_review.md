# Review Fixes
---

## 1. DEBUG-режим
В одном коммите `DEBUG` корректно парсится в bool, в более позднем — используется просто `os.getenv("DEBUG")`, из-за чего строка `"False"` остаётся truthy.  
**Фикс:** вернуть безопасный парсинг переменной окружения.

---

## 2. Monkey-patch DNS
В `apps.ready()` используется `DNS_NAME._fqdn = "task-pulse.local"`, что хрупко и трогает внутренности Django.  
**Фикс:** Django 5 уже поддерживает `EMAIL_MESSAGE_ID_FQDN` — этого достаточно. Monkey-patch убрать.

---

## 3. Аутентификация по email
`EmailBackend` делает `User.objects.get(email=email)` без нормализации и без проверки `is_active`.  
**Фиксы:**
- использовать `email__iexact`,
- проверять `user.is_active`,
- сохранить совместимость с кейсом, когда Django передаёт `username`.

---

## 4. Кейс-инсенситивная уникальность email
Сейчас email уникален только по точному совпадению.  
**Фикс:** добавить `UniqueConstraint(Lower("email"))`, иначе `User@ex.com` и `user@ex.com` считаются разными.

---

## 5. Email-токены
По тестам токены хранятся в базе в открытом виде и сравниваются напрямую.  
**Фикс:** хешировать токены (аналогично reset-password), чтобы утечка БД не раскрывала валидные токены.

---

## 6. ALLOWED_HOSTS / CSRF / CORS
В продакшене `ALLOWED_HOSTS = []`, что недопустимо.  
**Фиксы:**
- вынести `ALLOWED_HOSTS` в env,
- добавить `django-cors-headers`, если фронт на другом домене,
- указать `CSRF_TRUSTED_ORIGINS`.

---

## 7. Инфраструктура и DX
Не видно CI (GitHub Actions), `pre-commit`, контейнеризации.  
**Фикс:** добавить — это ускорит онбординг и ловлю регрессий.

---

# Замечания по доменной модели аккаунтов

## User
Унаследовано от `AbstractUser`, но логин — по email.  
**Проверить и исправить:**
- что поле `username` отключено (`username = None`) или хотя бы не `unique=True`,
- что `email = models.EmailField(unique=True, db_index=True)`,
- что `create_user(email=...)` не падает из-за требований `AbstractUser`.

---

## EmailVerificationToken
Тесты хорошие: TTL, `mark_used()`, идемпотентность.  
**Улучшения:**
- добавить индекс на `expires_at` (для регулярной очистки),
- добавить индекс на `user_id`,
- рассмотреть политику одного активного токена на пользователя (опционально).

---

## Invitation
Проверяется уникальность по `(email, invited_by)` — это верно.  
**Улучшения:**
- убедиться, что токен инвайта — `UUID` и `unique=True`,
- при необходимости добавить индексы на `used_at` / `accepted_at` для аналитики.

---

# Итог
Архитектура и тесты — отличные, база для зрелого проекта уже есть.  
Чтобы довести до production-friendly состояния, нужно:
- вернуть нормальную обработку `DEBUG`,
- убрать monkey-patch DNS,
- довести email-аутентификацию до безопасного и устойчивого варианта,
- улучшить безопасность токенов,
- привести ALLOWED_HOSTS/CSRF/CORS к боевым практикам,
- прикрутить CI, контейнеризацию и pre-commit.

После этих фиксов проект будет очень уверенной основой для дальнейшего роста.
